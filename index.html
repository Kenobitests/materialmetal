<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Arquimedes - Identificador de Metais</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;700&display=swap');
        body { font-family: 'JetBrains Mono', monospace; }
        .glass-panel { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: 2px solid white;
        }
        .option-btn.active {
            background-color: #3b82f6;
            border-color: #60a5fa;
            color: white;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#020617] text-slate-200 min-h-screen">

    <!-- Header -->
    <header class="p-4 border-b border-slate-800 flex justify-between items-center sticky top-0 bg-[#020617] z-50">
        <div>
            <h1 class="text-blue-500 text-[10px] font-bold tracking-[0.2em] uppercase leading-none">
                <i class="fas fa-atom animate-spin-slow"></i> Kenobi Lab Mobile
            </h1>
            <h2 class="text-lg font-light text-white italic">Arquimedes Analyzer</h2>
        </div>
        <div class="flex flex-col items-end">
            <span class="text-[8px] text-slate-500 uppercase">Status do Sistema</span>
            <div id="status-tag" class="text-[9px] font-bold text-green-500 flex items-center gap-1">
                <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-ping"></span> OPERACIONAL
            </div>
        </div>
    </header>

    <main class="p-4 max-w-lg mx-auto pb-10">
        
        <!-- Input Section -->
        <section class="glass-panel border border-slate-800 p-5 rounded-3xl shadow-2xl mb-6">
            <h3 class="text-white text-[10px] font-bold uppercase mb-5 tracking-widest flex items-center gap-2">
                <i class="fas fa-sliders-h text-blue-400"></i> Parâmetros de Entrada
            </h3>
            
            <div class="space-y-4">
                <div class="bg-black/40 p-3 rounded-xl border border-slate-800">
                    <label class="text-[9px] text-slate-500 uppercase block mb-1">Peso no Ar (Massa)</label>
                    <div class="flex items-center gap-2">
                        <input id="wAir" type="number" step="0.01" placeholder="0.00" 
                               class="w-full bg-transparent text-2xl text-blue-400 outline-none font-bold">
                        <span class="text-slate-600 text-xs">g</span>
                    </div>
                </div>

                <div class="bg-black/40 p-3 rounded-xl border border-slate-800">
                    <label class="text-[9px] text-slate-500 uppercase block mb-1">Peso da Água Deslocada (Empuxo)</label>
                    <div class="flex items-center gap-2">
                        <input id="wWater" type="number" step="0.01" placeholder="0.00"
                               class="w-full bg-transparent text-2xl text-cyan-400 outline-none font-bold">
                        <span class="text-slate-600 text-xs">g</span>
                    </div>
                </div>

                <div class="pt-2 px-1">
                    <div class="flex justify-between text-[9px] mb-3 uppercase font-bold text-slate-500">
                        <span>Tolerância de Erro (σ)</span>
                        <span id="precision-val" class="text-blue-400">±0.15</span>
                    </div>
                    <input id="precision" type="range" min="0.05" max="0.5" step="0.01" value="0.15" 
                           class="w-full h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
        </section>

        <!-- Questionário de Validação -->
        <section class="glass-panel border border-slate-800 p-5 rounded-3xl shadow-2xl mb-6">
            <h3 class="text-white text-[10px] font-bold uppercase mb-4 tracking-widest flex items-center gap-2">
                <i class="fas fa-microscope text-purple-400"></i> Filtros de Validação
            </h3>
            
            <div class="space-y-4">
                <div>
                    <p class="text-[9px] text-slate-500 uppercase mb-2 font-bold">O objeto é atraído por imã?</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="setMagnetic(true)" id="mag-yes" class="option-btn py-2 rounded-xl border border-slate-700 text-[10px] uppercase font-bold text-slate-400 hover:border-slate-500 transition-all">
                            <i class="fas fa-magnet mr-1"></i> Sim
                        </button>
                        <button onclick="setMagnetic(false)" id="mag-no" class="option-btn py-2 rounded-xl border border-slate-700 text-[10px] uppercase font-bold text-slate-400 hover:border-slate-500 transition-all">
                            <i class="fas fa-times mr-1"></i> Não
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Results Display -->
        <div id="results-area" class="hidden space-y-6">
            
            <!-- Density Hero -->
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-blue-600 p-4 rounded-3xl shadow-lg relative overflow-hidden">
                    <p class="text-[9px] font-bold uppercase text-blue-100">Densidade Exp.</p>
                    <div class="flex items-baseline gap-1">
                        <span id="density-val" class="text-3xl font-black text-white">0.000</span>
                    </div>
                    <p class="text-[8px] text-blue-200 uppercase font-bold">g/cm³</p>
                    <i class="fas fa-weight-hanging absolute -right-2 -bottom-2 text-4xl opacity-10"></i>
                </div>
                <div class="bg-slate-900 border border-slate-800 p-4 rounded-3xl relative overflow-hidden border-l-4 border-l-green-500">
                    <p class="text-[9px] font-bold uppercase text-slate-500">Confiança Máxima</p>
                    <div class="flex items-baseline gap-1">
                        <span id="top-prob-val" class="text-3xl font-black text-green-400">0%</span>
                    </div>
                    <p id="top-metal-name" class="text-[8px] text-slate-400 uppercase font-bold truncate tracking-tighter">---</p>
                </div>
            </div>

            <!-- Curve Chart -->
            <div class="bg-slate-900 border border-slate-800 p-4 rounded-3xl">
                <p class="text-[9px] text-slate-500 uppercase mb-4 font-bold tracking-widest text-center">Distribuição de Probabilidade</p>
                <div class="h-40">
                    <canvas id="probChart"></canvas>
                </div>
            </div>

            <!-- Ranking List -->
            <div class="bg-slate-900 border border-slate-800 p-4 rounded-3xl">
                <p class="text-[9px] text-slate-500 uppercase mb-4 font-bold">Ranking de Correspondência</p>
                <div id="ranking-list" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar pr-1">
                    <!-- JS fills this -->
                </div>
            </div>

            <!-- Scatter Plot -->
            <div class="bg-slate-900 border border-slate-800 p-4 rounded-3xl">
                <p class="text-[9px] text-slate-500 uppercase mb-4 font-bold text-center">Mapa de Densidade de Metais</p>
                <div class="h-56">
                    <canvas id="scatterChart"></canvas>
                </div>
                <p class="text-[8px] text-slate-600 mt-2 text-center italic">
                    A linha vertical representa sua medição. Pontos são metais reais.
                </p>
            </div>
        </div>

        <!-- Initial Placeholder -->
        <div id="placeholder" class="py-20 text-center border-2 border-dashed border-slate-800 rounded-3xl bg-slate-900/20">
            <div class="w-16 h-16 bg-slate-900 rounded-full flex items-center justify-center mx-auto mb-4 border border-slate-800">
                <i class="fas fa-balance-scale text-slate-600 text-xl"></i>
            </div>
            <p class="text-slate-500 text-[10px] uppercase tracking-[0.2em] font-bold">Aguardando Telemetria</p>
            <p class="text-slate-700 text-[8px] mt-2 px-10 leading-relaxed uppercase italic">Insira o peso no ar e o empuxo para iniciar a análise estatística</p>
        </div>

    </main>

    <script>
        const METALS_DB = [
            { name: 'Magnésio', density: 1.74, color: '#94a3b8', magnetic: false },
            { name: 'Alumínio', density: 2.70, color: '#38bdf8', magnetic: false },
            { name: 'Titânio', density: 4.54, color: '#818cf8', magnetic: false },
            { name: 'Zinco', density: 7.14, color: '#94a3b8', magnetic: false },
            { name: 'Estanho', density: 7.31, color: '#64748b', magnetic: false },
            { name: 'Ferro', density: 7.87, color: '#f97316', magnetic: true },
            { name: 'Aço', density: 8.00, color: '#78350f', magnetic: true },
            { name: 'Níquel', density: 8.90, color: '#94a3b8', magnetic: true },
            { name: 'Cobre', density: 8.96, color: '#f97316', magnetic: false },
            { name: 'Latão', density: 8.50, color: '#eab308', magnetic: false },
            { name: 'Prata', density: 10.49, color: '#cbd5e1', magnetic: false },
            { name: 'Chumbo', density: 11.34, color: '#475569', magnetic: false },
            { name: 'Paládio', density: 12.02, color: '#cbd5e1', magnetic: false },
            { name: 'Ouro 10k', density: 11.57, color: '#d97706', magnetic: false },
            { name: 'Ouro 14k', density: 13.07, color: '#ea580c', magnetic: false },
            { name: 'Ouro 18k (Amarelo)', density: 15.58, color: '#f59e0b', magnetic: false },
            { name: 'Ouro 18k (Branco)', density: 14.65, color: '#cbd5e1', magnetic: false },
            { name: 'Ouro 22k', density: 17.75, color: '#fbbf24', magnetic: false },
            { name: 'Ouro 24k (Puro)', density: 19.32, color: '#fcd34d', magnetic: false },
            { name: 'Tungstênio', density: 19.25, color: '#334155', magnetic: false },
            { name: 'Platina', density: 21.45, color: '#f8fafc', magnetic: false },
            { name: 'Iridio', density: 22.56, color: '#f1f5f9', magnetic: false }
        ];

        let probChart = null;
        let scatterChart = null;
        let isMagnetic = null; // null = ignorar, true/false = filtrar

        function setMagnetic(val) {
            if (isMagnetic === val) {
                isMagnetic = null;
                document.getElementById('mag-yes').classList.remove('active');
                document.getElementById('mag-no').classList.remove('active');
            } else {
                isMagnetic = val;
                document.getElementById('mag-yes').classList.toggle('active', val === true);
                document.getElementById('mag-no').classList.toggle('active', val === false);
            }
            update();
        }

        function getProb(x, mean, std) {
            return (1 / (std * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - mean) / std, 2));
        }

        function update() {
            const air = parseFloat(document.getElementById('wAir').value);
            const water = parseFloat(document.getElementById('wWater').value);
            const precision = parseFloat(document.getElementById('precision').value);
            
            document.getElementById('precision-val').innerText = `±${precision.toFixed(2)}`;

            if (!air || !water || air <= 0 || water <= 0) {
                document.getElementById('results-area').classList.add('hidden');
                document.getElementById('placeholder').classList.remove('hidden');
                return;
            }

            document.getElementById('results-area').classList.remove('hidden');
            document.getElementById('placeholder').classList.add('hidden');

            const densityExp = air / water;
            document.getElementById('density-val').innerText = densityExp.toFixed(3);

            // Cálculo das Probabilidades com Filtro Magnético
            const chances = METALS_DB.map(m => {
                let p = getProb(m.density, densityExp, precision);
                
                // Lógica de Filtro: Se o usuário definiu magnetismo, zera o que não bate
                if (isMagnetic !== null) {
                    if (m.magnetic !== isMagnetic) {
                        p = 0; // Se não coincide com o teste físico, probabilidade é descartada
                    } else {
                        p *= 2; // Dá um "boost" nos que coincidem
                    }
                }
                
                return { ...m, probRaw: p };
            });

            const sumProb = chances.reduce((a, b) => a + b.probRaw, 0);
            const normalized = chances.map(m => ({
                ...m,
                chance: sumProb > 0 ? (m.probRaw / sumProb) * 100 : 0
            })).sort((a, b) => b.chance - a.chance);

            const topMatch = normalized[0];
            document.getElementById('top-prob-val').innerText = topMatch.chance.toFixed(1) + '%';
            document.getElementById('top-metal-name').innerText = topMatch.chance > 0 ? topMatch.name : "Nenhuma correspondência";

            // Ranking
            const list = document.getElementById('ranking-list');
            list.innerHTML = '';
            normalized.filter(m => m.chance > 0.1).forEach(m => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 bg-black/40 p-2.5 rounded-xl border border-slate-800";
                div.innerHTML = `
                    <div class="w-1 h-6 rounded" style="background:${m.color}"></div>
                    <div class="flex-1">
                        <div class="flex justify-between text-[9px] font-bold text-white uppercase mb-1">
                            <span>${m.name} ${m.magnetic ? '<i class="fas fa-magnet text-blue-400 text-[7px]"></i>' : ''}</span>
                            <span class="text-blue-400 font-mono">${m.chance.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-slate-800 h-1 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-500 transition-all duration-500" style="width: ${m.chance}%"></div>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });

            // Gráfico Curva
            const curveLabels = [];
            const curveData = [];
            const startX = Math.max(0, densityExp - 5);
            const endX = densityExp + 5;
            for(let i = startX; i <= endX; i += 0.15) {
                curveLabels.push(i.toFixed(1));
                curveData.push(getProb(i, densityExp, precision));
            }

            if (probChart) probChart.destroy();
            probChart = new Chart(document.getElementById('probChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: curveLabels,
                    datasets: [{
                        data: curveData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        pointRadius: 0,
                        borderWidth: 2,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#475569', font: { size: 8 } }, grid: { display: false } },
                        y: { display: false }
                    }
                }
            });

            // Gráfico Dispersão
            const scatterPoints = METALS_DB.map(m => ({
                x: m.density,
                y: normalized.find(n => n.name === m.name).chance,
                name: m.name,
                color: m.color,
                isMatch: (isMagnetic === null || m.magnetic === isMagnetic) && normalized.find(n => n.name === m.name).chance > 1
            }));

            if (scatterChart) scatterChart.destroy();
            scatterChart = new Chart(document.getElementById('scatterChart').getContext('2d'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Metais Conhecidos',
                        data: scatterPoints,
                        backgroundColor: scatterPoints.map(p => p.isMatch ? p.color : '#1e293b'),
                        pointRadius: scatterPoints.map(p => p.isMatch ? 7 : 4),
                        pointHoverRadius: 9
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.raw.name}: ${ctx.raw.x} g/cm³`
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Densidade (g/cm³)', color: '#475569', font: { size: 8 } },
                            ticks: { color: '#475569', font: { size: 8 } },
                            grid: { color: '#1e293b' },
                            min: 0,
                            max: 23
                        },
                        y: {
                            title: { display: true, text: 'Afinidade (%)', color: '#475569', font: { size: 8 } },
                            ticks: { color: '#475569', font: { size: 8 } },
                            grid: { color: '#1e293b' },
                            min: 0
                        }
                    }
                },
                plugins: [{
                    id: 'verticalLine',
                    afterDraw: (chart) => {
                        const ctx = chart.ctx;
                        const x = chart.scales.x.getPixelForValue(densityExp);
                        ctx.save();
                        ctx.beginPath();
                        ctx.moveTo(x, chart.chartArea.top);
                        ctx.lineTo(x, chart.chartArea.bottom);
                        ctx.lineWidth = 2;
                        ctx.strokeStyle = '#3b82f6';
                        ctx.setLineDash([5, 5]);
                        ctx.stroke();
                        ctx.restore();
                    }
                }]
            });
        }

        document.querySelectorAll('input').forEach(el => el.addEventListener('input', update));
    </script>
</body>
</html>
